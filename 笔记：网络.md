<!-- TOC -->

- [CMD](#cmd)
- [帧同步](#帧同步)
    - [伪随机数](#伪随机数)
    - [轮班计时器](#轮班计时器)
- [状态同步](#状态同步)
- [游戏网络框架](#游戏网络框架)
    - [平台数据包模块](#平台数据包模块)
    - [连接管理器](#连接管理器)
    - [流管理器](#流管理器)
    - [事件管理器](#事件管理器)
    - [ghost管理器](#ghost管理器)
    - [移动管理器](#移动管理器)
- [网络模型](#网络模型)
    - [物理层](#物理层)
    - [链路层](#链路层)
        - [介质对应协议](#介质对应协议)
        - [以太网](#以太网)
            - [多播](#多播)
    - [网络层](#网络层)
        - [IPv4](#ipv4)
        - [IPv6](#ipv6)
            - [分片](#分片)
        - [ARP](#arp)
        - [子网](#子网)
        - [路由表](#路由表)
    - [传输层](#传输层)
        - [UDP](#udp)
        - [TCP](#tcp)
            - [三次握手](#三次握手)
            - [四次挥手](#四次挥手)
    - [应用层](#应用层)
        - [抓包工具](#抓包工具)

<!-- /TOC -->

# CMD #
ipconfig /all
ipconfig /flushdns

# 帧同步 #
对等网络模型（peer-to-peer model），需要O(n^2)的宽带，同步操作，战斗逻辑在客户端
## 伪随机数 ##
使用相同的种子，且调用次数相同
## 轮班计时器 ##
1. 将每轮（200ms内的）输入存在一个队列里，每轮结束后发送给其他所有玩家
2. 发送后过两轮（400ms）的时间再一起处理操作
3. 如果玩家跟不上计200ms计时器，停止模拟|踢出游戏|降低帧率

# 状态同步 #
客户端-服务器模型（client-server model，C/S），客户端常量的宽带，服务器O(n)的宽带，同步数据，战斗逻辑在服务器


# 游戏网络框架 #
1. 选择网络通讯协议，不可靠的UDP，还是稳定的TCP。
使用不可靠UDP时，划分数据：
- 非保障数据：不是游戏必须的数据，宽带有限时最先抛弃
- 保障数据：需要保障准确到达合到达顺序的，例如：发起攻击的事件
- 最近的状态数据：只有最新版本的数据是有用的，例如：当前的血条
- 最快保障数据：最高优先级，在可靠传输的基础上尽快到达。例如：移动信息
2. 选择网络模型（对等网络模型|客户端-服务器模型）
3. ↓
游戏模拟层（ghost管理器|移动管理器|事件管理器|其他）
流管理器
连接管理器
平台数据包模块

## 平台数据包模块 ##
只有这层针对特定平台，对标准套接字API的封装。 （数据包是网络传输中有一定格式的数据集合）

## 连接管理器 ##
将网络中两台计算机之间的连接抽象化。不能保障可靠传输，但可以确认传输到连接管理器的请求状态（指定数据是否被成功传输）
滑动窗口中接受域的位字段

## 流管理器 ##
将数据根据优先级排序，确认数据传输的最大速率，并把数据包整合发给连接管理器。

## 事件管理器 ##
事件队列（RPC，远程调用等）。按事件优先级排序，重新发送标记为可靠的事件。

## ghost管理器 ##
服务器发送关于客户端的动态数据。把相关数据标志为相关对象（id，状态掩码，优先级，状态变化），按状态变化，再按优先级排序

## 移动管理器 ##
尽快传输玩家的移动数据

# 网络模型 #
↓（RFC 1122）  
应用层                           数据  
传输层                  报文段报头------------  
网络层          数据包报头--------------------  
链路层  数据帧帧头-------------------数据帧帧尾  
物理层  ---------------物理介质---------------  

电路交换：通过许多连续的短电路来传输数据，这些电路必须时刻博连通。在数据传输完成前，这条线始终被占用
分组交换：把数据拆分为小块（分组），通过存储转发技术转发给另近分组，整段不必一直被占用，可以同时使用来传输不同数据

## 物理层 ##
通过物理介质实现网络数据传输。常见的物理介质有：Cat 6双绞线、电话线、同轴电缆、光纤、无线电波

## 链路层 ##
数据帧

职责：
- 定义主机的唯一标识方法，方便帧数据对接收方进行编址
- 定义帧的格式，包括目的地址的格式合所传输数据的格式
- 定义帧的长短，以便确定上层每次传输所能发送的数据大小
- 定义将帧转换为电子信号的物理方法，使之可以通过物理层传输

注意：
- 链路层是不可靠的，且不会做任何操作来确认帧抵达，或重新发送。
- 在传输一个数据时，可能会同时使用多种介质合链路层协议

### 介质对应协议 ###
物理介质                链路层协议
双绞线                  Ethernet (10,100,1000)BASE(T)
双绞铜线                Ethernet over copper(Eoc)
2.4GHz无线电波          802.11(n,b,g)
5GHz无线电波            802.11(n,ac)
850MHz无线电波          3G,4G
光纤                    Ethernet 10GBASE(SR,LR), FDDI(fiber distributed data interface, 光纤分布式数据接口)
同轴电缆                Ethernet over coax, DOCSIS(data over cable service interface specificatoin, 有线电缆数据服务接口规范)

### 以太网 ###
Ethernet 是基于以太网蓝皮书的一组协议。是在IEEE 820.3基础上定义的。


MAC(media access control address) ，主机标志符号。总共48位（6字节）， 前24位是组织唯一标准符（organizationally unique identifier, OUI），后24位由厂商分配。
MAC现在扩展到64位了， OUI从24位变40位， 24位厂商分配
MAC：FF:FF:FF:FF:FF:FF 是广播地址，表示同时向局域网中的所有主机发送该帧
MAC的OUI第七位表示是原始唯一地址(0)，还是生成的地址(1)。 现代系统默认使用随机MAC

人工将 MAC(EUI-48)到EUI-64:  1. 在OUI的右边插入 FF:EE   2. 设置OUI的第7位为1，表示 0全局 / 1本地      

1. 每个数据包的前导序列和帧开始标志符都一样，一般只用在网卡接受用，处理时会剥夺
2. 帧长度/类型域： 帧长度<=1500(MTU, maximum transmission unit, 最大传输单元)    协议类型>=1536 。 现代网卡可以发送巨型帧(9000字符)，通常指定解析类型
3. 帧检验序列：FCS, farame check sequence.  由除了前导序列和帧开始标识符生成的循环冗余检查(CRC32, cyclic redundancy check)
4. 集线器(hub)，物理层设备，只能发送给所有主机，主机自行判断是否是自己的数据。 
5. 交换机(switch)，链路层设备，记录主机的MAC，在知道目标MAC下，只需要发送给特定主机。若未知，可能泛洪（Flood）到所有端口（类似广播），随后学习并记录地址。
6. 多播帧，由交换机根据配置决定是广播还是选择性转发。以01:00:5E开头
7. 泛洪，交换机在目标MAC地址位置的情况下，泛洪到除发送方的端口，让其处理。若由回复，记录更新MAC地址表。触发泛洪的场景：新设备接入网络，MAC表老化，目标设备离线
8. 以太帧的最大传输单元（MTU, maximum transmission units）是1500字节

Bytes（字节）
0-7         前导序列（7字节）       帧开始标识符（1字节）
8-13        目标地址（6字节，MAC）
14-21       源  地址（6字节，MAC）  帧长度/类型域（2字节）
22-...      数据（46-1500字节）
...         帧检验序列（CRC32，4字节）

#### 多播 ####
默认情况下交换机接受到多播帧时无法对应到MAC地址，所以会泛洪，但启动IGMP监听后可以只发送给特定主机（节约宽带，但有解析IGMP报文并维护表的的延迟）。

IGMP：
启动条件：1. 交换机支持IGMP侦听功能（大部分企业级支持   2. 网络中存在IGMP查询器（Querier）（通常由路由器或三层交换机提供）
原理： 交换机会监听IGMP报文，进入/离开多播组。   路由器定期发送查询报文，确认组成员存活

## 网络层 ##
数据包

### IPv4 ###
Internet protocol version 4, IPv4. 定义唯一的IP地址（4字节）

- 本地IP地址是127.0.0.1，发送给本地IP地址的数据不会发送出去，而是直接处理。  理论上所有 127.0.0.0/8 的地址均为本地地址，但部分防火墙只允许127.0.0.1这样做
- 广播IP地址是255.255.255.255，发送给相同链路层的所有主机，但不被路由器转发出去。通常是将数据打包成链路层帧，并发送给广播MAC地址FF:FF:FF:FF:FF:FF
- IPv4包的包头至少是5*4=20字节
- IPv4包的最大长度是2^16-1=25535字节，  2^16=64KB=64*1024B=65536B
- 每经过一个路由 --TTL ，重新计算头部效应和。抛弃TTL等于0的
- 协议，1字节，解析数据内容所用的协议，

协议号  1字节，0~255
1是ICMP（网络控制报文ping、traceroute等），2是IGMP（组播），4是IP-in-IP，
6是TCP，17是UDP，
41是IPv6，47是GRE（VPN），
33是DCCP（数据报拥塞控制协议），
50是ESP（IPsec加密封装）51是AH（Ipsec认证头），
89是OSPF（开放最短路径优先路由），132是SCTP（流控制传输，TCP的替换）


每行4字节，32位
Bits（位）   IPV4是4        (15~5)*4字节                        包头长度+数据长度
0-31        版本号（4位）   IP包头长度（4位）  服务类型（8位）    IP包总长度（16位） --> 最多 2^16-1 = 65535 字节
32-63       片标识符（16位）                                    片标记（3位） 片偏移（13位）     -->  这三用来重组分片数据包
64-95       生存时间（8位，TTL）              协议（8位）        头部校验和（16位）
96-127                              源地址（32位）
128-159                             目标地址（32位）
160-...                             可选项（其他扩展，数据等）

### IPv6 ###
IPv46共16字节（128位），前8字节表示网络前缀，后8字节表示接口ID（可以手动设置）。 默认情况下设置为网卡的EUI-64.
1. 使用邻居发现协议(NDP, neighbor discovery protocol) 代替了地址解析协议(ARP)和动态主机配置协议(DHCP)的一些功能
2. IPv6的分片只能由发送方完成，接受方重组，中间路由不参与。
3. 发送方需要先使用路径MTU发现(PMTUD, Path MTU Discovery)获取路径的最小MTU，来避免分片；
4. 如果PMTUD(ICMPv6被禁用)无法使用，发送方需要数据分片，并附近分片扩展头
5. IPv6要求最小MTU为1280字节，如果实际更小需要链路层处理（IPv6 ove IPv4隧道，协议41）

表示方式：
2001:4a60:0000:8f1:0000:0000:0000:1013
2001:4a60:0:8f1:0:0:0:1013
2001:4a60:0:8f1::1013           只能有一个::表示若干个0

#### 分片 #####
当IP包大于链路层的最大传输单元(MTU)时，会把包拆分为小包，每个包的大小尽量是MTU的大小，来减少分包数量。如果 片标记!=0 || 片偏移!=0 ，那就是个分包，需要等所有包都到后重组继续处理
- 片标识符：同一组分包的标识符一样，取值是任意的，但极有可能是主机发送的第n个被分包的数据包
- 片标记：如果是分包，0表示最后个分包，0x4表示是分包，0x2表示永不分包（过大会直接抛弃）
- 片偏移：第一个分包是0， 片偏移(n+1) = 片偏移(n) + 数据(n)/8，一般头包是20+1480，下一个分包的片偏移就是 0+1480/8 = 185。 总数据长度=末分片的片偏移*8 +末分片数据长度
- 分片数量 = math.ceil(数据 / (MTU-包头长度))
- 目标地址主机接受到分片的时候，根据源地址和片标识符创建64KB的缓冲区，并根据片偏移重新组装数据，当末分片到达时，知道总长度，并开始判断重组的数据长度是否等于总长度，并传给上层做处理

注意：
1. 当分片丢失时，目标地址主机（接受方）必须丢弃整个数据包
2. 大的分片更容易丢失
3. 分片越多，包头越多，占用宽带越多
4. 最好将IP包限制在1300字节左右。 以太网MTU是1500，IPv4包头至少是20

以太网的MTU一般是1500，不过传输过程中如果遇到更小的MTU会继续分包
例如：
原包是20包头+3000数据个字节，用以太网网传输，那分片个数是 math.ceil( 3000/(1500-20) ) = 3， 每个分包的大小  20+1480, 20+1480, 20+40 个字节
            原包     分片1     分片2    分片3
版本号        4         4       4        4
包头长度      20        20      20       20

包总长度     3020       1500    1500     60
片标识符      0         12      12       12
片标记        0         0x4     0x4      0 
片偏移        0         0       185      370     

TTL          64         64      64       64
协议         17         17      17       17
源地址       IP1        IP1     IP1      IP1
目标地址     IP2        IP2     IP2      IP2

数据字节    3000        1480    1480      40

### ARP ###
ARP(address resolution protocol): 把Ip转换成MAC的协议，仅使用链路层发送数据包，不需要网络层的路由
- L = 硬件地址长度 + IP地址长度
- 硬件类型：链路层使用的硬件接口类型，以太网是1
- 协议类型：正在使用的网络层协议所对应的以太网类型，IPV4是0x0800
- 硬件地址长度：Mac的长度，大部分是6，少数是8
- IP地址长度：IP地址的长度，IPV4是4字节，IPV6是16字节
- 操作类型：1请求，2响应。 请求是广播的，响应是单播的

Bytes（字节）                                               MacLength                IPLength
0-7             硬件类型（2字节）    协议类型（2字节）    硬件地址长度（1字节）    IP地址长度（1字节）  操作类型（2字节）
8-7+L           发送方硬件地址（MacLength字节）                    发送方IP地址（IPLength字节）
8+L-7+2L        目标方硬件地址（MacLength字节）                    目标方IP地址（IPLength字节）

1. A向B发送请求，发送方IP、MAC是A， 目标IP是B，目标MAC未知（不填）。发送到以太网广播地址FF:FF:FF:FF:FF:FF，给每个主机发送
2. B收到A的请求，判断目标IP是自己，发送响应，发送方IP、MAC是B，目标IP、MAC是A。 

### 子网 ###
子网掩码：4字节，所有主机IP和子网掩码按位与(&)后结果相同的在同一子网。 能表示的IP数，要-2（主机位，网络地址全0，广播地址全1）
默认路由是 0.0.0.0/0 ，用来处理无匹配路由的数据包，通常指向默认网关

表示方法： 255.255.255.0  <--> (IP&掩码)/有效位数(24)  无类别域间路由（CIDR, classless interdomain routing），
例如：
18.19.100.0/24，
掩码是255.255.255.0，
主机的IP为18.19.100.1~254 ， 一般18.19.100.1是路由器的地址（网关地址）
特殊的18.19.100.0是网络地址，18.19.100.255是该子网的广播地址

子网掩码             二进制            有效位数         IP数
- 255.255.255.248   1...1000            29             6 = 2^3-2
- 255.255.255.192   1...1000000         26            62 = 2^6-2
- 255.255.255.0     1...00000000        24           254 = 2^8-2    
- 255.255.0.0                           16         65534 = 2^16-2
- 255.0.0.0                              8      16777214 = 2^24-2

### 路由表 ###
每个主机都会维护一个路由表，有网关IP，则会转发到网关，没有表示可以路由直达（同一链路层网络）。 一般路由器有多个网卡，每个网卡对应一个子网

例如：有两个子网 18.19.100.0/24   18.19.200.0/24 ，它们中间有个路由器来做转发. 外网18.181.0.0/24，IP18.181.0.29

18.19.100.2的主机路由表
行号        目标子网         网关（路由器IP）  网卡（本机的IP）
1       18.19.100.0/24          
2       18.19.200.0/24      18.19.100.1     18.19.100.2          
3       0.0.0.0/24          18.19.100.1     18.19.100.2

路由器的路由表
行号        目标子网            网关            网卡
1       18.19.100.0/24                      18.19.100.1
2       18.19.200.0/24                      18.19.200.1    
3       18.181.0.0/24       18.181.0.1      18.181.0.29
4       0.0.0.0/24          18.181.0.1      18.181.0.29

## 传输层 ##
报文段

端口：2字节的无符号数，用来标记数据包是哪个进程处理。由ICANN(IANA)注册派发。
一般表示为  IP地址:端口 , 如 18.19.20.21:80
0~1023系统端口   49152~65535动态端口

### UDP ###
UDP（user datagram protocol）不提供堵塞网络的流量限制服务，也不保证数据顺序传输和准确到达。

校验和（2字节）是可选的，默认是0，由UDP头，数据，和IP头的某些域计算得到，如果底层验证了数据，这个可忽略。

Bits位
0-31      源端口（2字节）     目标端口（2字节）
32-64     总长度（2字节）       校验和（2字节）
65-...    数据

### TCP ###
TCP（transmission control protocol）在两台主机间创建持久性的可靠的数据流传输，保证数据都按序到达，
(5~15)*4 = 20~60 字节。  
- 最大分段大小（MSS，maximum segment size）= 以太网MTU（1500）- IPv4头（20）-TCP头（20）= 1460
- 往返时间（RTT，round trip time）：发送方发送跟接收方分组的时间+接收方发送给发送方确认的时间，全国平均30ms
- 流量控制（窗口机制）：使用接受窗口告诉别的主机，自己还有多少接受缓存。 当收到确认的接受窗口时，发送方通过 另一方的接受窗口（SND.WND）-发送中的数据(SND.NXT-SND.UNA) = 可发送的新数据 。可以保护处理满的主机，但无法避免慢网络和路由器被淹没
- 序号回绕：序列号/确认号超过int32的最大值后会从0重新开始，通过时间戳辅佐判断新旧数据
- 延迟确认：接受到后不用马上回复，等待500ms或接受到下一个报文段时再回复
- 拥塞控制（congestion control）：作用于路由器，初始化为MSS的两倍，收到确认后+MSS，，超时/2.  AIMD（additive increase, multiplicative decrease）
- 纳格算法（Nagle's algorithm）；有未被确认的数据在传输时，收集数据，直到大于Min{MSS, 拥塞控制的窗口}，这时再发送。可选的，会增加延迟


- 序列号（sequence number，4字节），标志发送数据的第一个字节的序号。  Seq(n+1) = Seq(n) + DataLength(n+1)
- 确认号（acknowledgment number，4字节），希望接受到的下一个字节的序列号，并确认所有这个值之前的都正确接受。  Ack(n+1) = Ack(n) + RecDataLength(n)
- 数据偏移（data offset，4位）表示TCP头部的总长度，取值（5~15）-*4> 表示20~60字节
- 接受窗口（receive widnow，2字节）剩余的接受缓存区的大小。SND.WND，RCV.WND
- 紧急指针（urgent pointer，2字节）表示紧急数据的最后一个字节的下一个位置（正常数据的位置），在控制位设置了URG时生效
- 控制位（contol bits，9位）关于头部的元数据
SYN（Synchronize）：同步序列号以创建连接
ACK（Acknowledge）：确认号指端有效，三次握手的SYN-ACK及之后都是1
RST（Reset）：强制终止异常连接或拒绝非法请求。接受到时直接终止连接，无需四次挥手。 例如：收到未监听端口的SYN，或收到不匹配当前连接的报文，回应RST。 
FIN（Finish）：请求正常关闭连接，表示数据发送完毕
URG（Urgent）：表示由紧急数据要优先处理，配合紧急指针使用
PSH（Push）：接收方立刻将数据给应用层，不等待缓冲区填满。可能会被忽略（由应用层决定），如远程连接（Telnet）输入字符避免延迟
ECE（ECN-Echo）：通知发送方网络拥塞（接收方响应IP头的ECN字段）
CWR（Congestion Window Reduced）：发送方确认已减少拥塞窗口，缓解网络拥塞

Bits位
0-31             源端口（2字节）              目标端口（2字节）     
32-63                          序列号（4字节）（Seq）
64-95                          确认号（4字节）（Ack）
96-127   数据偏移（4位） 保留（3位） 控制位（9位）    接受窗口（2字节）
128-159          校验和（2字节）               紧急指针（2字节）
160-...                         选项/数据

TCP状态变量
Send Next(SND.NXT, Seq): 发送的下一个报文段的序列号，发送后直接更新。  SEN.NXT(n+1) = SEN.NXT(n) + DataLength 
Send Unacknowledged(SND.UNA): 最早尚未确认的报文段的序列号，接受到ACK后更新。
Send Window(SND.WND): 允许发送的数据量，收到数据确认后更新，接受到对面的Win后更新
Receive Next(RCV.NXT, Ack): 期望接受的下一个报文段序列号，接受到对面数据后更新
Receive Window(RCV.WND): 能接受的数据量（缓存区剩余容量），接受到对面数据或进程处理数据后更新


#### 三次握手 ####
两台主机建立一个新的TCP连接。
SYN时的Seq 是初始序列号（ISN），随机生成，防止旧连接报文的干扰

客户端发送SYN=1（Seq=x）  
服务器发送SYN=1, ACK=1（Seq=y，Ack=x+1）
客户端发送ACK=1（Ack=y+1）

#### 四次挥手 ####
半关闭状态：一方发送FIN后，仍可接受数据（需要ACK确认）
关闭连接：接受到对面的FIN且收到自己的FIN的ACK 或 发送自己的FIN后超时没收到ACK

FIN的Seq是最后一个数据字节的下一个序号。

主动方发送FIN=1，ACK=1  （Seq=x，Ack=?），主动方进入FIN_WAIT_1， 把FIN数据报放入发送缓存，并在必要时重传；不再接受上层的新数据；超时没有FIN的ACK确认关闭连接并删除连接状态
被动方回复ACK=1         （Seq=?，Ack=x+1），被动方进入CLOSE_WAIT；主动方接受到后进入FIN_WAIT_2, 不会超时关闭连接，仍可接受数据，等待接收方的FIN并回复ACK
被动方发送FIN=1，ACK=1  （Seq=y，Ack=x+1）被动方进入LAST_ACK，接收方把FIN数据报放入发送缓存，并在必要时重传；不再接受上层的新数据；超时没有FIN的ACK确认关闭连接并删除连接状态
主动方回复ACK=1         （Seq=x+1, Ack=y+1），主动方发送后进行TIME_WAIT，超时关闭； 被动方收到ACK后关闭连接

## 应用层 ##

### 抓包工具 ###

[WiresSark官网](https://www.wireshark.org/)   
[WiresSark教程](https://blog.csdn.net/zzwwhhpp/article/details/113077747)
