<!-- TOC -->

- [帧同步](#帧同步)
    - [伪随机数](#伪随机数)
    - [轮班计时器](#轮班计时器)
- [状态同步](#状态同步)
- [游戏网络框架](#游戏网络框架)
    - [平台数据包模块](#平台数据包模块)
    - [连接管理器](#连接管理器)
    - [流管理器](#流管理器)
    - [事件管理器](#事件管理器)
    - [ghost管理器](#ghost管理器)
    - [移动管理器](#移动管理器)
- [网络层](#网络层)
    - [物理层](#物理层)
    - [链路层](#链路层)
        - [介质对应协议](#介质对应协议)
        - [以太网](#以太网)
    - [网络层](#网络层-1)
        - [IPV4](#ipv4)

<!-- /TOC -->

# 帧同步 #
对等网络模型（peer-to-peer model），需要O(n^2)的宽带，同步操作，战斗逻辑在客户端
## 伪随机数 ##
使用相同的种子，且调用次数相同
## 轮班计时器 ##
1. 将每轮（200ms内的）输入存在一个队列里，每轮结束后发送给其他所有玩家
2. 发送后过两轮（400ms）的时间再一起处理操作
3. 如果玩家跟不上计200ms计时器，停止模拟|踢出游戏|降低帧率

# 状态同步 #
客户端-服务器模型（client-server model，C/S），客户端常量的宽带，服务器O(n)的宽带，同步数据，战斗逻辑在服务器


# 游戏网络框架 #
1. 选择网络通讯协议，不可靠的UDP，还是稳定的TCP。
使用不可靠UDP时，划分数据：
- 非保障数据：不是游戏必须的数据，宽带有限时最先抛弃
- 保障数据：需要保障准确到达合到达顺序的，例如：发起攻击的事件
- 最近的状态数据：只有最新版本的数据是有用的，例如：当前的血条
- 最快保障数据：最高优先级，在可靠传输的基础上尽快到达。例如：移动信息
2. 选择网络模型（对等网络模型|客户端-服务器模型）
3. ↓
游戏模拟层（ghost管理器|移动管理器|事件管理器|其他）
流管理器
连接管理器
平台数据包模块

## 平台数据包模块 ##
只有这层针对特定平台，对标准套接字API的封装。 （数据包是网络传输中有一定格式的数据集合）

## 连接管理器 ##
将网络中两台计算机之间的连接抽象化。不能保障可靠传输，但可以确认传输到连接管理器的请求状态（指定数据是否被成功传输）
滑动窗口中接受域的位字段

## 流管理器 ##
将数据根据优先级排序，确认数据传输的最大速率，并把数据包整合发给连接管理器。

## 事件管理器 ##
事件队列（RPC，远程调用等）。按事件优先级排序，重新发送标记为可靠的事件。

## ghost管理器 ##
服务器发送关于客户端的动态数据。把相关数据标志为相关对象（id，状态掩码，优先级，状态变化），按状态变化，再按优先级排序

## 移动管理器 ##
尽快传输玩家的移动数据

# 网络层 #
↓（RFC 1122）
应用层                           数据
传输层                  报文段报头------------
网络层          数据包报头--------------------
链路层  数据帧帧头-------------------数据帧帧尾
物理层  ---------------物理介质---------------

电路交换：通过许多连续的短电路来传输数据，这些电路必须时刻博连通。在数据传输完成前，这条线始终被占用
分组交换：把数据拆分为小块（分组），通过存储转发技术转发给另近分组，整段不必一直被占用，可以同时使用来传输不同数据

## 物理层 ##
通过物理介质实现网络数据传输。常见的物理介质有：Cat 6双绞线、电话线、同轴电缆、光纤、无线电波

## 链路层 ##
职责：
- 定义主机的唯一标识方法，方便帧数据对接收方进行编址
- 定义帧的格式，包括目的地址的格式合所传输数据的格式
- 定义帧的长短，以便确定上层每次传输所能发送的数据大小
- 定义将帧转换为电子信号的物理方法，使之可以通过物理层传输

注意：
- 链路层是不可靠的，且不会做任何操作来确认帧抵达，或重新发送。
- 在传输一个数据时，可能会同时使用多种介质合链路层协议

### 介质对应协议 ###
物理介质                链路层协议
双绞线                  Ethernet (10,100,1000)BASE(T)
双绞铜线                Ethernet over copper(Eoc)
2.4GHz无线电波          802.11(n,b,g)
5GHz无线电波            802.11(n,ac)
850MHz无线电波          3G,4G
光纤                    Ethernet 10GBASE(SR,LR), FDDI(fiber distributed data interface, 光纤分布式数据接口)
同轴电缆                Ethernet over coax, DOCSIS(data over cable service interface specificatoin, 有线电缆数据服务接口规范)

### 以太网 ###
Ethernet 是基于以太网蓝皮书的一组协议。是在IEEE 820.3基础上定义的。


MAC(media access control address) ，主机标志符号。总共48位（6字节）， 前24位是组织唯一标准符（organizationally unique identifier, OUI），后24位由厂商分配。
MAC现在扩展到64位了， OUI从24位变40位， 24位厂商分配。  --> 48位的变64位， OUI右边插入FFFE
MAC：FF:FF:FF:FF:FF:FF 是广播地址，表示同时向局域网中的所有主机发送该帧

1. 每个数据包的前导序列和帧开始标志符都一样，一般只用在网卡接受用，处理时会剥夺
2. 帧长度/类型域： 帧长度<=1500(MTU, maximum transmission unit, 最大传输单元)    协议类型>=1536 。 现代网卡可以发送巨型帧(9000字符)，通常指定解析类型
3. 帧检验序列：FCS, farame check sequence.  由除了前导序列和帧开始标识符生成的循环冗余检查(CRC32, cyclic redundancy check)
4. 以前的集线器(hub)网络发送给所有主机，主机自行判断是否是自己的数据。 只有链路层时只能这样
5. 现代的交互机(switch)记录主机的MAC或者IP，只需要发送给特定主机 

Bytes（字节）
0-7         前导序列（7字节）       帧开始标识符（1字节）
8-13        目标地址（6字节，MAC）
14-21       源  地址（6字节，MAC）  帧长度/类型域（2字节）
22-...      数据（46-1500字节）
...         帧检验序列

## 网络层 ##

### IPV4 ###
Internet protocol version 4, IPV4. 定义唯一的IP地址（4字节）

每行4字节，32位
Bits（位）   IPV4是4        (15~5)*4                           包头长度+数据长度
0-31        版本号（4位）   IP包头长度（4位）  服务类型（8位）    IP包总长度（16位）
32-63       标识符（16位）                                     标记（3位） 片偏移（13位）     -->  这三用来重组分片数据包
64-95       生存时间（8位，TTL）              协议（8位）        头部校验和（16位）
96-127                              源地址（32位）
128-159                             目标地址（32位）
160-...                             可选项（其他扩展，数据等）